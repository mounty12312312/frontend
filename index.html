<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Мерч Самокат</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
      background-color: white;
      color: black;
    }
    .header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: white;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
    }
    .header-button {
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      color: #007bff;
    }
    .header-button:hover {
      text-decoration: underline;
    }
    .balance {
      margin-left: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .balance #user-balance-value {
      margin-top: 5px;
      font-size: 14px;
      color: #555;
    }
    .loading-container {
      display: none;
      position: fixed;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 1001;
      width: 300px;
      padding: 10px;
      text-align: left;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .loading-container.show {
      display: block;
    }
    #products {
      display: flex; /* Используем Flexbox */
      flex-wrap: wrap; /* Разрешаем перенос строк */
      justify-content: space-between; /* Равномерно распределяем элементы */
      gap: 20px; /* Устанавливаем отступы между элементами */
      padding: 80px 0px 0px; /* Отступ сверху для заголовка */
      width: 100%;
    }
    .product {
      border: 1px solid #ccc;
      padding: 10px;
      width: calc(50% - 30px); /* Уменьшаем ширину, чтобы учесть отступы */
      max-width: 400px;
      box-sizing: border-box; /* Учитываем padding и border в ширине */
      display: flex;
      flex-direction: column; /* Выравниваем содержимое по вертикали */
      align-items: center; /* Центрируем содержимое */
      margin: 10px; /* Добавляем отступы по бокам */
    }
    .product img {
      width: 100%; /* Изображение занимает всю ширину блока */
      height: auto; /* Сохраняем пропорции */
      object-fit: cover; /* Обрезаем изображение, если оно не помещается */
      max-height: 200px; /* Максимальная высота изображения */
    }
    .cart-item, .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .cart-item span {
  flex: 1; /* Название товара занимает доступное пространство */
  margin-right: 10px; /* Отступ между названием и количеством */
}

.cart-item .quantity-controls {
  display: flex; /* Группируем кнопки "+" и "-" */
  gap: 5px; /* Отступ между кнопками */
  align-items: center; /* Выравниваем кнопки по центру */
}
    .cart-item button, .history-item button {
      padding: 5px 10px; /* Добавляем внутренние отступы для кнопок */
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: white;
      border-radius: 5px; /* Скругляем углы кнопок */
    }
    .cart-item button:hover {
  background-color: #f0f0f0; /* Эффект при наведении */
}
    .cart-total, .history-total {
      margin-top: 10px;
      text-align: right;
    }
    .back-button {
      margin-top: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      color: #007bff;
    }
    .back-button:hover {
      text-decoration: underline;
    }
    /* Анимация появления (выпадения из центра) */
@keyframes fadeIn {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

/* Анимация исчезновения (закрытия) */
@keyframes fadeOut {
  from {
    transform: scale(1);
    opacity: 1;
  }
  to {
    transform: scale(0.8);
    opacity: 0;
  }
}

.cart-container,
.history-container {
  display: none;
  position: fixed;
  top: 80px;
  right: 0;
  width: 100%;
  max-width: 400px;
  height: calc(100vh - 80px);
  background-color: white;
  border-left: 1px solid #ccc;
  box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
  padding: 20px;
  box-sizing: border-box;
  transform: translateX(100%);
  transition: transform 0.3s ease-out;
  overflow-y: auto;
}

.cart-container.show,
.history-container.show {
  transform: translateX(0);
  display: block;
}

.cart-container h2,
.history-container h2 {
  margin-bottom: 20px;
  padding-right: 40px; /* Место для кнопки назад */
}

.back-button {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  color: #666;
  cursor: pointer;
  padding: 0;
}

.back-button:hover {
  color: #333;
}

.checkout-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: #007bff;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.checkout-button:hover {
  background-color: #0056b3;
}

.checkout-form-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.checkout-form {
  background-color: white;
  padding: 30px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-sizing: border-box;
}

.form-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.form-buttons button {
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}

.form-buttons .cancel {
  background-color: #f8f9fa;
  border: 1px solid #ddd;
}

.form-buttons .submit {
  background-color: #007bff;
  color: white;
  border: none;
}
    .load-more-button {
      margin-top: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      color: #007bff;
    }
    .load-more-button:hover {
      text-decoration: underline;
    }
    .order-container {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-direction: row;
      background-color: #f9f9f9;
    }
    .order-date {
      font-weight: bold;
    }
    .order-products {
      flex-grow: 1;
      margin-left: 10px;
      margin-right: 10px;
      font-size: 14px;
    }
    .order-total {
      font-weight: bold;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="balance">
      Баланс: <span id="user-balance-value" style="display: none;">0 баллов</span>
      <span id="user-balance-text" style="display: none;">Нет баланса</span>
    </div>
    <button class="header-button" onclick="toggleCart()">Корзина</button>
    <button class="header-button" onclick="toggleHistory()">История заказов</button>
  </div>
  <div id="products"></div>
  <div class="cart-container" id="cart-container">
    <div class="header-container">
      <h2>Корзина</h2>
      <button class="back-button" onclick="toggleCart()">Назад</button>
    </div>
    <ul id="cart-items"></ul>
    <div class="cart-bottom">
      <button class="checkout-button" onclick="showCheckoutForm()">Оформить заказ</button>
      <div id="cart-total">0 баллов</div>
    </div>
  </div>
  <div class="history-container" id="history-container">
    <div class="header-container">
      <h2>История заказов</h2>
      <button class="back-button" onclick="toggleHistory()">Назад</button>
    </div>
    <div id="history-items"></div>
  </div>
  <div class="loading-container" id="loading-container">
    Подождите...
  </div>
  <div class="checkout-form-container" id="checkout-form-container">
    <div class="checkout-form">
      <h3>Оформление заказа</h3>
      <div class="form-group">
        <label for="sender-name">ФИО отправителя*</label>
        <input type="text" id="sender-name" required>
      </div>
      <div class="form-group">
        <label for="sender-phone">Телефон отправителя*</label>
        <input type="tel" id="sender-phone" required>
      </div>
      <div class="form-group">
        <label for="recipient">ФИО получателя*</label>
        <input type="text" id="recipient" required>
      </div>
      <div class="form-group">
        <label for="phone">Телефон получателя*</label>
        <input type="tel" id="phone" required>
      </div>
      <div class="form-group">
        <label for="city">Город*</label>
        <input type="text" id="city" required>
      </div>
      <div class="form-group">
        <label for="address">Адрес доставки*</label>
        <input type="text" id="address" required>
      </div>
      <div class="form-buttons">
        <button class="cancel" onclick="hideCheckoutForm()">Отмена</button>
        <button class="submit" onclick="submitOrder()">Подтвердить</button>
      </div>
    </div>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Инициализация Telegram Mini Apps SDK
    const telegram = window.Telegram.WebApp;
    telegram.expand();
    // Получение initDataUnsafe
    const initDataUnsafe = telegram.initDataUnsafe;
    let telegramId = null;
    if (initDataUnsafe && initDataUnsafe.user) {
      telegramId = initDataUnsafe.user.id;
    } else {
      console.error('Не удалось получить данные пользователя');
    }
    console.log('Telegram ID:', telegramId);
    const BACKEND_URL = 'https://backend-ten-swart-36.vercel.app';
    let cartItems = {};
    const cartItemsList = document.getElementById('cart-items');
    const cartTotalElement = document.getElementById('cart-total');
    const cartTotalContainer = document.getElementById('cart-total-container');
    const cartButton = document.getElementById('cart-button');
    let userBalanceValue = document.getElementById('user-balance-value');
    let userBalanceText = document.getElementById('user-balance-text');
    const loadingContainer = document.getElementById('loading-container');

    // Добавляем константы для кэширования
    const CACHE_DURATION = 5 * 60 * 1000; // 5 минут
    const CACHE_KEYS = {
      PRODUCTS: 'cached_products',
      USER_BALANCE: 'cached_user_balance',
      ORDERS: 'cached_orders'
    };

    // Создаем и добавляем оверлей загрузки сразу после определения функции
    function createLoadingOverlay() {
      let loadingOverlay = document.getElementById('loading-overlay');
      if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.style.display = 'none';
        loadingOverlay.innerHTML = '<div class="loading-text">Подождите...</div>';
        document.body.appendChild(loadingOverlay);
      }
      return loadingOverlay;
    }

    // Обновляем порядок выполнения при загрузке страницы
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOMContentLoaded event triggered');
      
      // Сначала создаем оверлей загрузки
      createLoadingOverlay();
      
      try {
        // Затем загружаем данные
        await fetchUserBalance();
        await fetchProducts();
        updateCartDisplay();
      } catch (error) {
        console.error('Error during initial data loading:', error);
      }
    });

    // Обновляем функции показа/скрытия загрузки
    function showLoading() {
      const loadingOverlay = createLoadingOverlay();
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function hideLoading() {
      const loadingOverlay = createLoadingOverlay();
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    // Обновляем функцию fetchProducts с обработкой ошибок
    async function fetchProducts() {
      try {
        console.log('Fetching products...');
        showLoading();
        
        const url = `${BACKEND_URL}/api/products`;
        console.log('Request URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const products = await response.json();
        console.log('Products received:', products);
        displayProducts(products);
        
      } catch (error) {
        console.error('Error fetching products:', error);
      } finally {
        hideLoading();
      }
    }

    // Выносим отображение продуктов в отдельную функцию
    function displayProducts(products) {
      const productsContainer = document.getElementById('products');
      productsContainer.innerHTML = '';
      products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.setAttribute('data-id', product[0]);
        productDiv.innerHTML = `
          <img src="${product[4]}" alt="${product[1]}">
          <h3>${product[1]}</h3>
          <p>${product[2]}</p>
          <p>Цена: ${product[3]}</p>
          <button onclick="addToCart(${product[0]}, '${product[1]}', ${product[3]})">Добавить в корзину</button>
        `;
        productsContainer.appendChild(productDiv);
      });
    }

    async function fetchUserBalance() {
      if (!telegramId) {
        console.error('Не удалось получить ID пользователя');
        return;
      }
      
      try {
        // Проверяем кэш
        const cached = localStorage.getItem(CACHE_KEYS.USER_BALANCE);
        if (cached) {
          const { data, timestamp } = JSON.parse(cached);
          if (Date.now() - timestamp < CACHE_DURATION) {
            updateUserBalance(data);
            return;
          }
        }

        showLoading();
        const response = await fetch(`${BACKEND_URL}/api/user/${telegramId}`);
        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }
        const user = await response.json();
        
        if (!Array.isArray(user) || user.length !== 2) {
          throw new Error('Неверный формат данных пользователя');
        }
        
        const [userId, balance] = user;
        
        // Сохраняем в кэш
        localStorage.setItem(CACHE_KEYS.USER_BALANCE, JSON.stringify({
          data: balance,
          timestamp: Date.now()
        }));
        
        updateUserBalance(balance);
      } catch (error) {
        console.error('Ошибка при получении баланса:', error);
        updateUserBalance(null);
      } finally {
        hideLoading();
      }
    }

    function updateUserBalance(balance) {
      console.log('Обновление баланса:', balance);
      console.log('Элемент для обновления баланса:', userBalanceValue);
      console.log('Текущее значение баланса:', userBalanceValue ? userBalanceValue.textContent : 'null');

      if (userBalanceValue && userBalanceText) {
        if (balance === null || balance === undefined) {
          userBalanceText.style.display = 'block';
          userBalanceText.textContent = 'Нет баланса';
          userBalanceValue.style.display = 'none';
        } else {
          userBalanceText.style.display = 'none';
          userBalanceValue.style.display = 'block';
          userBalanceValue.textContent = `${balance} баллов`;
        }
      } else {
        console.error('Элементы с id="user-balance-value" или id="user-balance-text" не найдены');
      }

      // Обновление баланса в корзине
      const totalCost = parseFloat(cartTotalElement.textContent);
      if (totalCost > 0) {
        cartButton.textContent = `Корзина: ${totalCost.toFixed(2)} баллов`;
      } else {
        cartButton.textContent = 'Корзина';
      }
    }

    function addToCart(productId, productName, productPrice) {
      if (!cartItems[productId]) {
        cartItems[productId] = { name: productName, price: productPrice, quantity: 1 };
      } else {
        cartItems[productId].quantity++;
      }
      updateCartDisplay();
    }

    function updateCartItemQuantity(productId, change) {
      if (cartItems[productId]) {
        cartItems[productId].quantity += change;
        if (cartItems[productId].quantity <= 0) {
          delete cartItems[productId];
        }
        updateCartDisplay();
      }
    }

    // Функция для получения даты в МСК (UTC+3)
    function getMoscowDate() {
      const now = new Date();
      // Получаем смещение в минутах для МСК (UTC+3)
      const mskOffset = 3 * 60;
      // Получаем локальное смещение в минутах
      const localOffset = -now.getTimezoneOffset();
      // Вычисляем разницу в миллисекундах
      const diffOffset = (mskOffset - localOffset) * 60 * 1000;
      
      // Создаем новую дату с учетом смещения
      const mskDate = new Date(now.getTime() + diffOffset);
      
      // Форматируем дату в формате YYYY-MM-DD
      return mskDate.toISOString().split('T')[0];
    }

    // Обновляем функцию updateCartDisplay
    function updateCartDisplay() {
      const cartItemsList = document.getElementById('cart-items');
      const cartTotalElement = document.getElementById('cart-total');
      const checkoutButton = document.querySelector('.checkout-button');
      
      if (!cartItemsList || !cartTotalElement || !checkoutButton) {
        console.error('Required elements not found');
        return;
      }
      
      cartItemsList.innerHTML = '';
      let totalCost = 0;

      if (Object.keys(cartItems).length === 0) {
        const noItemsMessage = document.createElement('p');
        noItemsMessage.textContent = 'Корзина пуста';
        noItemsMessage.style.textAlign = 'center';
        noItemsMessage.style.color = '#888';
        cartItemsList.appendChild(noItemsMessage);
        
        checkoutButton.disabled = true;
        checkoutButton.style.opacity = '0.5';
        checkoutButton.style.cursor = 'not-allowed';
        checkoutButton.style.backgroundColor = '#cccccc';
        
        cartTotalElement.textContent = '0 баллов';
        cartButton.textContent = 'Корзина';
      } else {
        checkoutButton.disabled = false;
        checkoutButton.style.opacity = '1';
        checkoutButton.style.cursor = 'pointer';
        checkoutButton.style.backgroundColor = '#007bff';
        
        for (const productId in cartItems) {
          const item = cartItems[productId];
          const li = document.createElement('li');
          li.className = 'cart-item';
          
          li.innerHTML = `
            <span>${item.name}</span>
            <div class="quantity-controls">
              <button onclick="updateCartItemQuantity(${productId}, -1)">-</button>
              <span>${item.quantity} x ${item.price} баллов</span>
              <button onclick="updateCartItemQuantity(${productId}, 1)">+</button>
            </div>
          `;
          
          cartItemsList.appendChild(li);
          totalCost += item.quantity * item.price;
        }
        
        cartTotalElement.textContent = `${totalCost.toFixed(2)} баллов`;
        cartButton.textContent = `Корзина: ${totalCost.toFixed(2)} баллов`;
      }
    }

    // Добавляем новые функции для работы с формой
    function showCheckoutForm() {
      document.getElementById('checkout-form-container').style.display = 'flex';
    }

    function hideCheckoutForm() {
      document.getElementById('checkout-form-container').style.display = 'none';
    }

    async function submitOrder() {
      const senderName = document.getElementById('sender-name').value;
      const senderPhone = document.getElementById('sender-phone').value;
      const recipient = document.getElementById('recipient').value;
      const phone = document.getElementById('phone').value;
      const city = document.getElementById('city').value;
      const address = document.getElementById('address').value;

      // Проверяем заполнение обязательных полей
      if (!senderName || !senderPhone || !recipient || !phone || !city || !address) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
      }

      // Добавляем данные доставки к заказу
      const deliveryInfo = {
        senderName,
        senderPhone,
        recipient,
        phone,
        city,
        address
      };

      try {
        await checkout(deliveryInfo);
        hideCheckoutForm();
      } catch (error) {
        console.error('Ошибка при оформлении заказа:', error);
        alert('Произошла ошибка при оформлении заказа');
      }
    }

    // Обновляем функцию checkout
    async function checkout(deliveryInfo) {
      if (!telegramId) {
        alert('Не удалось получить ID пользователя');
        return;
      }
      
      try {
        showLoading();
        
        const orderData = {
          telegramId,
          products: cartItems,
          totalCost: parseFloat(document.getElementById('cart-total').textContent),
          date: getMoscowDate(), // Используем новую функцию для даты
          deliveryInfo
        };

        console.log('Отправляемые данные заказа:', orderData);
        
        const orderResponse = await fetch(`${BACKEND_URL}/api/order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });

        console.log('Статус ответа:', orderResponse.status);
        console.log('Заголовки ответа:', Object.fromEntries(orderResponse.headers.entries()));

        if (!orderResponse.ok) {
          const errorText = await orderResponse.text();
          console.error('Текст ошибки:', errorText);
          throw new Error(`Ошибка при оформлении заказа: ${orderResponse.status}. ${errorText}`);
        }

        const result = await orderResponse.json();
        console.log('Результат запроса:', result);
        
        if (result.success) {
          console.log('Заказ успешно создан, очищаем кэш');
          clearCache();
          
          console.log('Обновляем баланс пользователя');
          await fetchUserBalance();
          
          console.log('Очищаем корзину');
          cartItems = {};
          updateCartDisplay();
          
          alert('Заказ успешно оформлен!');
          toggleCart();
        } else {
          throw new Error(result.message || 'Ошибка при оформлении заказа');
        }
      } catch (error) {
        console.error('Ошибка при оформлении заказа:', error);
        alert(error.message || 'Произошла ошибка при оформлении заказа');
      } finally {
        hideLoading();
      }
    }

    function addOrderToHistory(order) {
  const historyItemsList = document.getElementById('history-items');
  // Создаем новый элемент для заказа
  const orderContainer = document.createElement('div');
  orderContainer.className = 'order-container';

  // Дата заказа
  const orderDate = document.createElement('div');
  orderDate.className = 'order-date';
  orderDate.textContent = new Date(order.date).toLocaleDateString();

  // Товары в заказе
  const orderProducts = document.createElement('div');
  orderProducts.className = 'order-products';
  for (const productId in order.products) {
    const product = order.products[productId];
    const productItem = document.createElement('div');
    productItem.textContent = `${product.name}, ${product.quantity} шт.`; // Обновленный формат
    orderProducts.appendChild(productItem);
  }

  // Общая сумма заказа
  const orderTotal = document.createElement('div');
  orderTotal.className = 'order-total';
  orderTotal.textContent = `${order.totalCost} баллов`;

  // Добавляем элементы в контейнер заказа
  orderContainer.appendChild(orderDate);
  orderContainer.appendChild(orderProducts);
  orderContainer.appendChild(orderTotal);

  // Добавляем заказ в начало списка
  historyItemsList.prepend(orderContainer);
}
    let orders = [];
    let currentPage = 1;
    const ordersPerPage = 5;

    async function fetchOrderHistory() {
  try {
    // Проверяем кэш
    const cached = localStorage.getItem(CACHE_KEYS.ORDERS);
    if (cached) {
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp < CACHE_DURATION) {
        orders = data;
        displayOrders(currentPage);
        return;
      }
    }

    const response = await fetch(`${BACKEND_URL}/api/orders?telegramId=${telegramId}`);
    if (!response.ok) {
      throw new Error(`Ошибка HTTP: ${response.status}`);
    }
    const userOrders = await response.json();
    orders = userOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Сохраняем в кэш
    localStorage.setItem(CACHE_KEYS.ORDERS, JSON.stringify({
      data: orders,
      timestamp: Date.now()
    }));
    
    displayOrders(currentPage);
  } catch (error) {
    console.error('Ошибка при получении истории заказов:', error);
    alert('Ошибка при получении истории заказов');
  }
}

    function displayOrders(page) {
      const historyItemsList = document.getElementById('history-items');
      const start = (page - 1) * ordersPerPage;
      const end = page * ordersPerPage;
      const pageOrders = orders.slice(start, end);
      if (pageOrders.length > 0) {
        pageOrders.forEach(order => {
          const orderContainer = document.createElement('div');
          orderContainer.className = 'order-container';

          const orderDate = document.createElement('div');
          orderDate.className = 'order-date';
          orderDate.textContent = new Date(order.date).toLocaleDateString();

          const orderProducts = document.createElement('div');
          orderProducts.className = 'order-products';
          for (const productId in order.products) {
            const product = order.products[productId];
            const productItem = document.createElement('div');
            productItem.textContent = `${product.name}, ${product.quantity} шт.`;
            orderProducts.appendChild(productItem);
          }

          const orderTotal = document.createElement('div');
          orderTotal.className = 'order-total';
          orderTotal.textContent = `${order.totalCost} баллов`;

          orderContainer.appendChild(orderDate);
          orderContainer.appendChild(orderProducts);
          orderContainer.appendChild(orderTotal);

          historyItemsList.appendChild(orderContainer);
        });
      }
      const loadMoreButton = document.getElementById('load-more-button');
      if (end >= orders.length) {
        loadMoreButton.style.display = 'none'; // Скрываем кнопку, если больше нет заказов
      } else {
        loadMoreButton.style.display = 'block'; // Показываем кнопку, если есть еще заказы
      }
    }

    function loadMoreOrders() {
      currentPage++;
      displayOrders(currentPage);
    }

    function toggleCart() {
  const cartContainer = document.getElementById('cart-container');
  const historyContainer = document.getElementById('history-container');

  if (cartContainer.classList.contains('show')) {
    // Если корзина уже открыта, закрываем её с анимацией
    cartContainer.classList.remove('show');
    cartContainer.classList.add('hide');

    // Скрываем элемент после завершения анимации
    setTimeout(() => {
      cartContainer.classList.remove('hide');
    }, 300); // Время анимации (0.3s)
  } else {
    // Если корзина закрыта, открываем её
    cartContainer.classList.add('show');
  }

  // Скрываем историю заказов, если она открыта
  historyContainer.classList.remove('show');
  historyContainer.classList.remove('hide');
}

function toggleHistory() {
  const historyContainer = document.getElementById('history-container');
  const cartContainer = document.getElementById('cart-container');

  if (historyContainer.classList.contains('show')) {
    // Если история уже открыта, закрываем её с анимацией
    historyContainer.classList.remove('show');
    historyContainer.classList.add('hide');

    // Скрываем элемент после завершения анимации
    setTimeout(() => {
      historyContainer.classList.remove('hide');
    }, 300); // Время анимации (0.3s)
  } else {
    // Если история закрыта, открываем её
    historyContainer.classList.add('show');
  }

  // Скрываем корзину, если она открыта
  cartContainer.classList.remove('show');
  cartContainer.classList.remove('hide');
}

    
   // Дополнительная проверка после загрузки DOM
document.addEventListener('DOMContentLoaded', () => {
console.log('DOMContentLoaded event triggered');
userBalanceValue = document.getElementById('user-balance-value');
userBalanceText = document.getElementById('user-balance-text');
console.log('Элемент с id="user-balance-value":', userBalanceValue);
console.log('Элемент с id="user-balance-text":', userBalanceText);
if (userBalanceValue && userBalanceText) {
console.log('Элементы с id="user-balance-value" и id="user-balance-text" найдены');
fetchUserBalance();
} else {
console.error('Элементы с id="user-balance-value" или id="user-balance-text" не найдены');
}
});

    // Запуск функций после загрузки страницы
    window.onload = () => {
      setTimeout(() => {
        fetchProducts();
        fetchOrderHistory();
        updateCartDisplay()
      }, 100); // Задержка 100 мс
    };

    // Добавляем функцию очистки кэша после успешной покупки
    function clearCache() {
      localStorage.removeItem(CACHE_KEYS.USER_BALANCE);
      localStorage.removeItem(CACHE_KEYS.ORDERS);
    }
  </script>
</body>
</html>